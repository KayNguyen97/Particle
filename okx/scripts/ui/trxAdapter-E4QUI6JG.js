import{a as I,b as C,f as b}from"./chunk-7MX3OHNE.js";import"./chunk-2BSLA752.js";import"./chunk-FLCN6MAI.js";import{D as S}from"./chunk-UXFKODVN.js";import"./chunk-XKG5DY6K.js";import"./chunk-6PGLMYAE.js";import"./chunk-RMQJRDTF.js";import"./chunk-2YLR7R2N.js";import{a as D,b as V}from"./chunk-MVLY6WUP.js";import{f as B,h as K}from"./chunk-ZEAKIEIQ.js";import{a as O}from"./chunk-5KSDRGLW.js";import"./chunk-DQTCC3FF.js";import"./chunk-O5LVHMPV.js";import{D as z,L as A,Pa as X}from"./chunk-CVJKAN5R.js";import"./chunk-A5Y2KVNP.js";import"./chunk-GXQ645QR.js";import"./chunk-DQ2NYVYI.js";import"./chunk-C2H3SRET.js";import"./chunk-V4YVDLI4.js";import"./chunk-Z37GURZ6.js";import{b as W}from"./chunk-IYYFWVWL.js";import"./chunk-RYNAOZ73.js";import"./chunk-GKHVFCKF.js";import{f as L,m as d,n as c,o as v}from"./chunk-6V2G2Z5W.js";d();v();var U=L(z());d();v();d();v();function x(s){var t=[],a=s.split("/");return a.forEach(function(r){var n=parseInt(r,10);isNaN(n)||(r.length>1&&r[r.length-1]==="'"&&(n+=2147483648),t.push(n))}),t}function N(s,t){function a(r,n,o){return r>=n.length?o:t(n[r],r).then(function(e){return o.push(e),a(r+1,n,o)})}return Promise.resolve().then(function(){return a(0,s,[])})}function R(s,t){for(var a=0,r=0,n=t;r<64;){var o=s[n];if(a|=(o&127)<<r,n+=1,!(o&128))return a&=4294967295,{value:a,pos:n};r+=7}throw new Error("Too many bytes when decoding varint.")}var Z=function(s){return s&&s.statusCode,s},_=4,H=1,m=224,$=2,j=4,q=5,F=8,J=10,Q=6,y=250,Y=function(){function s(t,a){a===void 0&&(a="TRX"),this.transport=t,t.decorateAppAPIMethods(this,["getAddress","getECDHPairKey","signTransaction","signTransactionHash","signPersonalMessage","getAppConfiguration"],a)}return s.prototype.getAddress=function(t,a){var r=x(t),n=c.Buffer.alloc(H+r.length*_);return n[0]=r.length,r.forEach(function(o,e){n.writeUInt32BE(o,1+4*e)}),this.transport.send(m,$,a?1:0,0,n).then(function(o){var e=o[0],i=o[1+e];return{publicKey:o.slice(1,1+e).toString("hex"),address:o.slice(1+e+1,1+e+1+i).toString("ascii")}})},s.prototype.getNextLength=function(t){var a=R(t,0),r=R(t,a.pos);return(a.value&7)===0?r.pos:r.value+r.pos},s.prototype.signTransaction=function(t,a,r){var n=this,o=x(t),e=c.Buffer.from(a,"hex"),i=[],h=c.Buffer.alloc(H+o.length*_);for(h[0]=o.length,o.forEach(function(l,w){h.writeUInt32BE(l,1+4*w)});e.length>0;){var g=this.getNextLength(e);if(g>y)throw new Error("Too many bytes to encode.");if(h.length+g>y){i.push(h),h=c.Buffer.alloc(0);continue}h=c.Buffer.concat([h,e.slice(0,g)]),e=e.slice(g,e.length)}i.push(h);var u=[],E,T=i.length;if(r!==void 0)for(var f=0;f<r.length;f+=1){var p=c.Buffer.from(r[f],"hex");i.push(p)}if(i.length===1)u.push(16);else{u.push(0);for(var f=1;f<i.length-1;f+=1)f>=T?u.push(160|f-T):u.push(128);r!==void 0&&r.length?u.push(168|r.length-1):u.push(144)}return N(i,function(l,w){return n.transport.send(m,j,u[w],0,l).then(function(P){E=P})}).then(function(){return E.slice(0,65).toString("hex")},function(l){throw Z(l)})},s.prototype.signTransactionHash=function(t,a){var r=x(t),n=c.Buffer.alloc(H+r.length*_);return n[0]=r.length,r.forEach(function(o,e){n.writeUInt32BE(o,1+4*e)}),n=c.Buffer.concat([n,c.Buffer.from(a,"hex")]),this.transport.send(m,q,0,0,n).then(function(o){return o.slice(0,65).toString("hex")})},s.prototype.getAppConfiguration=function(){return this.transport.send(m,Q,0,0).then(function(t){var a=(t[0]&8)>0,r=(t[0]&1<<2)>0,n=(t[0]&1<<1)>0,o=(t[0]&1<<0)>0;t[1]===0&&t[2]===1&&t[3]<2&&(o=!0,n=!1),t[1]===0&&t[2]===1&&t[3]<5&&(r=!1);var e={version:"".concat(t[1],".").concat(t[2],".").concat(t[3]),versionN:t[1]*1e4+t[2]*100+t[3],allowData:o,allowContract:n,truncateAddress:r,signByHash:a};return e})},s.prototype.signPersonalMessage=function(t,a){for(var r=this,n=x(t),o=c.Buffer.from(a,"hex"),e=0,i=[],h=o.length.toString(16),g="00000000".substr(h.length)+h,u=c.Buffer.concat([c.Buffer.from(g,"hex"),o]),E=function(){var f=e===0?y-1-n.length*4:y,p=e+f>u.length?u.length-e:f,l=c.Buffer.alloc(e===0?1+n.length*4+p:p);e===0?(l[0]=n.length,n.forEach(function(w,P){l.writeUInt32BE(w,1+4*P)}),u.copy(l,1+4*n.length,e,e+p)):u.copy(l,0,e,e+p),i.push(l),e+=p};e<u.length;)E();var T;return N(i,function(f,p){return r.transport.send(m,F,p===0?0:128,0,f).then(function(l){T=l})}).then(function(){return T.slice(0,65).toString("hex")})},s.prototype.getECDHPairKey=function(t,a){var r=x(t),n=c.Buffer.from(a,"hex"),o=c.Buffer.alloc(1+r.length*4+n.length);return o[0]=r.length,r.forEach(function(e,i){o.writeUInt32BE(e,1+4*i)}),n.copy(o,1+4*r.length,0,n.length),this.transport.send(m,J,0,1,o).then(function(e){return e.slice(0,65).toString("hex")})},s}(),k=Y;V();var M=L(W());X();K();var G=class extends b{async makeApp(){await this.initLedgerTransPorter(),this.app||(this.app=new k(this.ledgerTransPorter))}async getAddressPromise(t){await this.makeApp();let a=[];for(let r=t*5;r<(t+1)*5;r++){let n=`44'/195'/0'/0/${r}`,{address:o}=await this.app.getAddress(n,!1,!0);a.push({address:o,index:r,path:n})}return a}async getAddress(t=0){return await Promise.race([this.getAddressPromise(t),this.throwTimeoutError()])}async getTokens(t,a){let r=t.map(({address:n})=>n);try{let n=await B(D.getChainToken,{addressList:r,coinId:a});if((n==null?void 0:n.code)===0){let{data:o}=n;o.forEach(({address:e,coinAmount:i})=>{let h=(0,U.find)(t,{address:e});h.coinAmount=i})}}catch(n){console.log(n)}return t}async signTransaction(t,a){try{C.openModal(I.confirm);let r=t.hdPathMap[A];await this.checkLedgerConnection();let{getHardWareRawTransaction:n,getHardWareSignedTransaction:o}=await O(),{raw:e}=await n(M.Currency.TRX,{data:a}),i=await this.app.signTransaction(r,e);if(i==="01000103019000")throw new Error(I.wrongApp);let h=await o(M.Currency.TRX,{raw:e,sig:i});return C.closeModal(),h}catch(r){return this.handleErrors(r,A)}}async approveRequestOfSignMessage(t,a){let{params:r,localType:n}=t,{hdPathMap:o}=a,{message:e}=r,i=`0x${c.Buffer.from(e,"utf8").toString("hex")}`,h=o[n];return{signature:`0x${await this.app.signPersonalMessage(h,i)}`}}async approveRequestOfSignTransaction(t,a){let{localType:r,params:{transaction:{txID:n}}}=t,{hdPathMap:o}=a,e=o[r];return{result:await this.app.signPersonalMessage(e,n)}}async approveRequest({requestMeta:t,walletInfo:a}){return await this.makeApp(),t.method===S.SIGN_MESSAGE||t.method===S.RPC_SIGN_MESSAGE?this.approveRequestOfSignMessage(t,a):t.method===S.SIGN_TRANSACTION||t.method===S.RPC_SIGN_TRANSACTION?this.approveRequestOfSignTransaction(t,a):{}}},dt=new G;export{dt as default};

window.inOKXExtension = true;
window.ASSETS_BUILD_TYPE = "publish";

//# sourceMappingURL=trxAdapter-E4QUI6JG.js.map
